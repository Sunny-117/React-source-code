<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hello SunnyReact</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/React-source-code/assets/css/0.styles.6b1062d2.css" as="style"><link rel="preload" href="/React-source-code/assets/js/app.ecbbc941.js" as="script"><link rel="preload" href="/React-source-code/assets/js/2.bbbe772e.js" as="script"><link rel="preload" href="/React-source-code/assets/js/7.c2b71158.js" as="script"><link rel="prefetch" href="/React-source-code/assets/js/3.9d07cf01.js"><link rel="prefetch" href="/React-source-code/assets/js/4.b7d0708f.js"><link rel="prefetch" href="/React-source-code/assets/js/5.9e2f4ca7.js"><link rel="prefetch" href="/React-source-code/assets/js/6.c7b54f12.js">
    <link rel="stylesheet" href="/React-source-code/assets/css/0.styles.6b1062d2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/React-source-code/" aria-current="page" class="home-link router-link-exact-active router-link-active"><!----> <span class="site-name">Hello SunnyReact</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="https://react.docschina.org/" target="_blank" rel="noopener noreferrer">https://react.docschina.org/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
仓库地址：<a href="https://github.com/Sunny-117/React-source-code" target="_blank" rel="noopener noreferrer">https://github.com/Sunny-117/React-source-code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
注意：学习 React 解决问题的思路和系统设计。React 是一个产品级别的项目，产品级别的考虑的东西很多。SunnyReact 只考虑 React 的核心代码思路。
​</p> <h1 id="工程结构"><a href="#工程结构" class="header-anchor">#</a> 工程结构：</h1> <h1 id="reactrouter"><a href="#reactrouter" class="header-anchor">#</a> ReactRouter</h1> <h2 id="创建一个-match-对象"><a href="#创建一个-match-对象" class="header-anchor">#</a> <strong>创建一个 match 对象</strong></h2> <p>第三方库：<a href="https://www.npmjs.com/package/path-to-regexp" target="_blank" rel="noopener noreferrer">path-to-regexp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，用于将一个字符串正则（路径正则，path regexp），用于匹配路径
参数：path：<strong>路径规则转换成正则表达式</strong>
​</p> <p>先简单地使用一下此库：
​</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> pathToRegexp <span class="token keyword">from</span> <span class="token string">&quot;path-to-regexp&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">pathToRegexp</span><span class="token punctuation">(</span><span class="token string">&quot;/news/:id/:page&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&quot;/news/123/5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">pathToRegexp</span><span class="token punctuation">(</span><span class="token string">&quot;/news/:id/:page&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>编写 matchPath.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 得到匹配结果（为了得到match对象，params只是match对象的一个属性而已），如果没有匹配，返回null
 * @param {*} path 路径规则
 * @param {*} pathname 真实地址
 * @param {*} options 相关配置，该配置是一个对象，该对象中，可以出现：exact、sensitive、strict
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">matchPath</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> pathname<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>函数 matchPath 实现原理</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">matchPath</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> pathname<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//保存路径规则中的关键字</span>
  <span class="token keyword">const</span> regExp <span class="token operator">=</span> <span class="token function">pathToRegexp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> <span class="token function">getOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> regExp<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//匹配url地址</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//没有匹配</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//匹配了</span>
  <span class="token keyword">let</span> groups <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 去掉匹配到的第一项</span>
  groups <span class="token operator">=</span> groups<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//得到匹配的分组结果</span>

  <span class="token comment">/*的到 {
      id:'sadasd',
      page:'1'
  } */</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token function">getParams</span><span class="token punctuation">(</span>groups<span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">isExact</span><span class="token operator">:</span> pathname <span class="token operator">===</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 事实上是否是精确匹配</span>
    params<span class="token punctuation">,</span>
    path<span class="token punctuation">,</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// url并不是pathname，而是匹配的path对应的部分，即正则匹配结果里面的第一项</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中，getOption 函数，是讲传入的 react-router 配置，转换为 path-to-regexp 的配置，专门为了处理这块：end: opts.exact，是否精确匹配</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 将传入的react-router配置，转换为path-to-regexp的配置
 * 专门为了处理这块：end: opts.exact
 * 是否精确匹配
 * @param {*} options
 */</span>
<span class="token keyword">function</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">exact</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sensitive</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">strict</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>defaultOptions<span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">sensitive</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>sensitive<span class="token punctuation">,</span>
    <span class="token literal-property property">strict</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>strict<span class="token punctuation">,</span>
    <span class="token literal-property property">end</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>exact<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>getParams 函数，是根据</strong>匹配的分组结果，得到一个 params 对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getParams</span><span class="token punctuation">(</span><span class="token parameter">groups<span class="token punctuation">,</span> keys</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> groups<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> groups<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    obj<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="创建-history-对象"><a href="#创建-history-对象" class="header-anchor">#</a> 创建 history 对象</h2> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/758572/1646467606308-33899b03-94af-4974-9d74-cb97444a6d19.png#clientId=ucae9bc9e-396c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=394&amp;id=u41fc50e7&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1370&amp;originWidth=2162&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=586034&amp;status=done&amp;style=none&amp;taskId=uadfc7afc-2569-433f-954c-ad22f3d584c&amp;title=&amp;width=621" alt="image.png"></p> <p>该对象提供了一些方法，用于控制或监听地址的变化。</p> <p>该对象<strong>不是</strong>window.history，而是一个抽离的对象，它提供统一的 API 接口，封装了具体的实现</p> <ul><li>createBrowserHistory 产生的控制浏览器真实地址的 history 对象</li> <li>createHashHistory 产生的控制浏览器 hash 的 history 对象</li> <li>createMemoryHistory 产生的控制内存中地址数组的 history 对象</li></ul> <p>history 对象共同的特点：维护了一个地址栈
<img src="https://cdn.nlark.com/yuque/0/2022/png/758572/1646467582771-53e9b57b-0674-4e51-bf93-e91db400dfe8.png#clientId=ucae9bc9e-396c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=345&amp;id=u38c84800&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=940&amp;originWidth=764&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=29671&amp;status=done&amp;style=none&amp;taskId=u060f463b-6355-4eb3-9575-b0be882e8d6&amp;title=&amp;width=280" alt="image.png"></p> <p>用到第三方库：<a href="https://www.npmjs.com/package/history" target="_blank" rel="noopener noreferrer">history<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>以下三个函数，虽然名称和参数不同，但返回的对象结构(history)完全一致，只是具体的实现不一样</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/758572/1646467500402-9cf59dca-ef4b-4078-b6cb-78bc20cbfc73.png#clientId=ucae9bc9e-396c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=464&amp;id=u4622f4f7&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=928&amp;originWidth=1346&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=76460&amp;status=done&amp;style=none&amp;taskId=u9b045887-59b9-414a-a68d-94b9b6d2f50&amp;title=&amp;width=673" alt="image.png"></p> <h3 id="history-对象"><a href="#history-对象" class="header-anchor">#</a> history 对象</h3> <ul><li>action：当前地址栈，<strong>最后一次</strong>操作的类型
<ul><li>如果是通过 createXXXHistory 函数新创建的 history 对象，action 固定为 POP</li> <li>如果调用了 history 的 push 方法，action 变为 PUSH</li> <li>如果调用了 history 的 replace 方法，action 变为 REPLACE</li></ul></li> <li>push：向当前地址栈指针位置，入栈一个地址</li> <li>replace：替换指针指向的地址</li> <li>go：控制当前地址栈指针偏移，如果是 0，地址不变；如果是负数，则后退指定的步数；如果是正数，则前进指定的步数；</li> <li>length：当前栈中的地址数量</li> <li>goBack：相当于 go(-1)</li> <li>goForward：相当于 go(1)</li> <li>location：表达当前地址中的信息</li> <li>listen：函数，用于监听地址栈指针的变化
<ul><li>该函数接收一个函数作为参数，该参数表示地址变化后要做的事情
<ul><li>参数函数接收两个参数</li> <li>location：记录了新的地址</li> <li>action：进入新地址的方式
<ul><li>POP：指针移动，调用 go、goBack、goForward、用户点击浏览器后退按钮</li> <li>PUSH：调用 history.push</li> <li>REPLACE：调用 history.replace</li></ul></li></ul></li> <li>该函数有一个返回值，返回的是一个函数，用于取消监听</li></ul></li> <li>block：用于设置一个阻塞，当页面发生跳转时，会将指定的消息传递到 getUserConfirmation，并调用 getUserConfirmation 函数
<ul><li>该函数接收一个字符串作为参数，表示消息内容，也可以接收一个函数作为参数，函数的返回值是消息内容</li> <li>该函数返回一个取消函数，调用取消函数可以解除阻塞</li></ul></li> <li>createHref：basename+url</li></ul> <h3 id="createbrowserhistory"><a href="#createbrowserhistory" class="header-anchor">#</a> createBrowserHistory</h3> <p>创建一个使用浏览器 History Api 的 history 对象</p> <p>配置对象：</p> <ul><li>basename：设置根路径</li> <li>forceRefresh：地址改变时是否强制刷新页面</li> <li>keyLength：location 对象使用的 key 值长度
<ul><li>地址栈中记录的并非字符串，而是一个 location 对象</li></ul></li> <li>getUserConfirmation：一个函数，该函数当调用 history 对象 block 函数后，发生页面跳转时运行</li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/758572/1646467907346-ff0c7eff-173b-4fec-b240-77164b747c19.png#clientId=ucae9bc9e-396c-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=518&amp;id=u05a7e80b&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1036&amp;originWidth=1820&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=140835&amp;status=done&amp;style=none&amp;taskId=u8f3ccd32-da8f-4c64-a13f-af4cddc528b&amp;title=&amp;width=910" alt="image.png">
​</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createBrowserHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;history&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token function">createBrowserHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>createBrowserHistory <span class="token operator">=</span> createBrowserHistory<span class="token punctuation">;</span>
window<span class="token punctuation">.</span>h <span class="token operator">=</span> <span class="token function">createBrowserHistory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">basename</span><span class="token operator">:</span> <span class="token string">&quot;/news&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">forceRefresh</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">keyLength</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token function-variable function">getUserConfirmation</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(msg);</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认值</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 测试：h.push('/as')</span>
window<span class="token punctuation">.</span>unblock <span class="token operator">=</span> window<span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">你真的要进入</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">吗？</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span>unListen <span class="token operator">=</span> window<span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>h<span class="token punctuation">.</span>action <span class="token operator">=</span> action<span class="token punctuation">;</span> <span class="token comment">//listen地方的action才是需要的action，window.h.action怪异，所以在此处赋值</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="createhashhistory"><a href="#createhashhistory" class="header-anchor">#</a> createHashHistory</h3> <p>创建一个使用浏览器 hash 的 history 对象</p> <p>配置对象：</p> <ul><li>hashType：#号后给定的路径格式
<ul><li>hashbang：被 chrome 弃用，#!+路径</li> <li>noslash：#a/b/c</li> <li>slash：#/a/b/c</li></ul></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createHashHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;history&quot;</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>createHashHistory <span class="token operator">=</span> createHashHistory<span class="token punctuation">;</span>
window<span class="token punctuation">.</span>h <span class="token operator">=</span> <span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">hashType</span><span class="token operator">:</span> <span class="token string">&quot;slash&quot;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">getUserConfirmation</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span>unblock <span class="token operator">=</span> window<span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">你真的要进入</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">吗？</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span>unListen <span class="token operator">=</span> window<span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>h<span class="token punctuation">.</span>action <span class="token operator">=</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="creatememoryhistory"><a href="#creatememoryhistory" class="header-anchor">#</a> createMemoryHistory</h3> <p>创建一个使用内存中的地址栈的 history 对象，一般用于没有地址栏的环境(手机)，内存路由</p> <p>配置对象：详见 memoryHistory.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createMemoryHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;history&quot;</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>createMemoryHistory <span class="token operator">=</span> createMemoryHistory<span class="token punctuation">;</span>
window<span class="token punctuation">.</span>h <span class="token operator">=</span> <span class="token function">createMemoryHistory</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">initialEntries</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/abc&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 表示初始数组内容</span>
  <span class="token literal-property property">initialIndex</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 默认指针指向的数组下标</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span>unblock <span class="token operator">=</span> window<span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">你真的要进入</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">吗？</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="手写-createbrowserhistory"><a href="#手写-createbrowserhistory" class="header-anchor">#</a> 手写 createBrowserHistory</h2> <h3 id="创建-location"><a href="#创建-location" class="header-anchor">#</a> 创建 location</h3> <p>state 处理逻辑：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> historyState <span class="token operator">=</span> window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
</code></pre></div><ol><li>如果 historyState 没有值，则 state 为 undefined</li> <li>如果 historyState 有值
<ol><li>如果值的类型不是对象</li> <li>是对象
<ol><li>该对象中有 key 属性，将 key 属性作为 location 的 key 属性值，并且将 historyState 对象中的 state 属性作为 state 属性值</li> <li>如果没有 key 属性，则直接将 historyState 赋值给 state</li></ol></li></ol></li></ol> <p>​</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/React-source-code/assets/js/app.ecbbc941.js" defer></script><script src="/React-source-code/assets/js/2.bbbe772e.js" defer></script><script src="/React-source-code/assets/js/7.c2b71158.js" defer></script>
  </body>
</html>
